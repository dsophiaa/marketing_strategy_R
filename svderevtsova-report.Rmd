---
title: 'HW 2: marketing strategy'
author: "Деревцова Софья, svderevtsova"
output: 
  html_document:
    code_folding: hide
---


## Задача

Нам предоставлены данные о клиентах и их покупках в некоторой компании. Необходимо провести разведывательный анализ данных, исследовать взаимосвязи между переменными, построить модель, которая бы предсказывала, примет ли клиент предложение в рамках кампании (переменная Response). Компания запустила пробную маркетинговую кампанию в одном из магазинов и теперь необходимо произвести анализ результатов, перед тем, как расширять ее на остальные магазины. 

### Загрузка данных и преобразование

```{r message = FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(readr)
library(lubridate)
library(stringr)
library(coin)
library(tidyverse)
library(rpart)
library(rpart.plot)

marketing = read.csv("~/shared/minor2_2022/1-Intro/hw2/marketing_campaign.csv")
```
Выполним необходимые преобразования, чтобы в последующем нам было удобнее анализировать данных и строить модель:
- представим значения в колонке Education как факторы
- данные в столбцах AcceptedCmp, Complain, Response представим как логические переменные
- информацию о семейном положении тоже представим как факторную переменную

```{r message = FALSE, warning=FALSE}
marketing$Education = as.factor(marketing$Education)
marketing$AcceptedCmp = as.logical(marketing$AcceptedCmp)
marketing$Complain = as.logical(marketing$Complain)
marketing$Response = as.logical(marketing$Response)
marketing$Marital_Status = as.factor(marketing$Marital_Status)
```

### Исследовательские вопросы и тесты

Теперь, когда мы уже изучили структуру датасета и имеем представление о том, какие там есть переменные, мы можем сформулировать основные исследовательские вопросы, а также гипотезы.  

#### Вопрос 1

**Вопрос:**   
Отличается ли число покупок в интернете, совершенное теми, кто откликнулся на предложение компании и теми, кто на него не откликнулся?  
Для формирования гипотез выделим две группы: откликнулись на предложение компании и не откликнулись на предложение компании (по значениям из столбца Response)  

**Гипотезы:**  
**H0:** разница между средним числа покупок в интернете у двух групп равно нулю  
**H1:** разница между средним числа покупок в интернете у двух групп не равно нулю  

**Тест:**  

Так как мы хотим сравнить средние у тех, кто откликнулся на предложение и не откликнулся, то воспользуемся для этого t-тестом, так как именно t-критерий Стьюдента является одним из самых популярных тестов, позволяющих сравнить средние значения в двух группах.   

```{r message = FALSE, warning=FALSE}
t.test(NumWebPurchases ~ Response, marketing)
```

**Вывод:**  
С развитием e-commerce становится все легче покупать товары в интернете, а компании часто предоставляют дополнительный сервис, такой как курьерская доставка, ускоренная сборка заказа, для тех, кто совершает покупки в интернете. Мы сделали догадку о том, что люди, которые часто совершают покупки в интернете становятся более лояльны к компании, а значит и более склонны принимать предложения компании.   

```{r message = FALSE, warning=FALSE}
rows_q1 = c(-7.2828, t.test(NumWebPurchases ~ Response, marketing)$p.value)
columns_q1 = c("t", "p-value ")
table_q1 = data.frame(Type = columns_q1, Value = rows_q1)
knitr::kable(table_q1, align = "ll")
```

Из результатов видно, что p-значение нашего теста меньше альфа = 0,05, поэтому мы отвергаем нулевую гипотезу теста. 
Благодаря t-тесту мы видим, что значение t-статистики большое, а p-value маленькое, также мы видим, что значение 0 не покрывается 95% интервалом. То есть, существует статистически значимая разница между средним числом покупок в интернете у тех, кто откликнулся на предложение компании и тех, кто не откликнулся на него.    

Визуализируем два распределения: число покупок в интернете у двух групп (откликнулись и не откликнулись на предложение компании). Для более наглядного представления исключим выбросы (поставим критерий для NumWebPurchases). Визуализацию осуществим с помощью двух графиков плотности распределения, которые позволяют обеспечить бОльшую наглядность.  


```{r message = FALSE, warning=FALSE}
ggplot(data = (marketing %>% filter(NumWebPurchases <= 22)), 
       aes(x = NumWebPurchases, group = Response, fill = Response)) +
  geom_density(alpha = 0.5) + scale_fill_manual(values = c("orange", "green")) +
  geom_vline(xintercept = mean((marketing %>% filter(Response == TRUE))$NumWebPurchases), color = "darkgreen",
             lty = 2) +
  geom_vline(xintercept = mean((marketing %>% filter(Response == FALSE))$NumWebPurchases), color = "darkorange",
             lty = 2) +
  ggtitle("Распределение количества покупок в инетрнете среди\nпринявших и не принявших предложение компании") +
  xlab("количество покупок в интернете") +
  ylab("плотность распределния") + 
  labs(fill = "Принял предложение\nкомпании (T-да, F-нет)")

```

Таким образом, мы видим, что средние у двух групп отличаются, а значит можно сделать вывод о том, что число покупок в интернете и реакция на предложение компании взаимосвязаны. С точки зрения построения модели, мы можем сделать вывод о том, что критерий NumWebPurchases влияет на переменную Response, а значит, что при построении дерева нам нельзя будет выкидывать ее из рассмотрения. Если говорить в целом, то результаты теста и графическое представление говорит нам о том, что клиенты, которые часто покупают в интернете, более склонные положительно реагировать на предложение компании, а значит было бы разумно и эффективно размещать информацию о новых промо-акциях именно в интернет магазине или дополнительно предлагать акции клиентам интернет-магазина, например, по электронной почте.  

#### Вопрос 2

**Вопрос:**  
Справедливо ли утверждение о том, что пользователи, которые откликнулись на предыдущую кампанию чаще откликаются и на последующую?  
  
**Гипотезы:**  
**H0:** пользователи, которые откликнулись на предыдущую кампанию не откликаются на последующую  
**H1:** пользователи, которые откликнулись на предыдущую кампанию откликаются на последующую  
  
**Тест:** 
Мы будем сравнивать две бинарные переменные, которые принимают значения TRUE/FALSE в зависимости от критерия. Для этого мы воспользуемся тестом хи-квадрат, который позволяет проверить гипотезу про доли в категориях. То есть мы сравним долю тех, кто откликнулся и не откликнулся на предыдущее предложение, среди откликнувшихся на нынешнее предложение. 

```{r message = FALSE, warning=FALSE}
ch = chisq.test(marketing$AcceptedCmp, marketing$Response)
ch
```

**Вывод:**
Мы предполагаем, что клиенты, которые не откликнулись на предыдущее предложение компании с большей вероятностью не откликнутся и на нынешнее, так как их, скорее всего, вообще не интересуют никакие акции и предложения. 
```{r message = FALSE, warning=FALSE}
rows_q2 = c(162.741, ch$p.value)
columns_q2 = c("X-squared", "p-value ")
table_q2 = data.frame(Type = columns_q1, Value = rows_q1)
knitr::kable(table_q2, align = "ll")
```

Наблюдаемые значения
```{r message = FALSE, warning=FALSE}
ch$observed
```
Ожидаемые значения (как выглядела бы эта таблица, если все распределялось случайно)

```{r message = FALSE, warning=FALSE}
ch$expected
```
Отклонения от ожидаемого можно визуализировать

```{r message = FALSE, warning=FALSE}
library(vcd)
assoc(table(marketing$AcceptedCmp, marketing$Response), gp=shading_max, rot_labels = c(0, 0, 0, 0), rot_varnames = c(0, 0, 0, 0))
```
Хи-квадрат представляет собой распределение суммы квадратов случайных нормальных величин, в нашем тесте значение хи-квадрат достаточно большое, это говорит о том, что нулевую гипотезу можно отвергнуть. Помимо этого, мы видим, что p-value очень мало. Из этого мы делаем вывод, что для маркетинговой кампании будет разумно сфокусироваться в первую очередь на тех клиентах, кто уже когда-то положительно реагировал на предложение компании.  

### Предсказание отклика на кампанию
**Работа с данными**  
Сначала разделим выборку на тренировочную и тестовую.   
```{r message = FALSE, warning=FALSE}
set.seed(1234)
marketing_train = marketing %>% sample_frac(.8)
marketing_test = anti_join(marketing, marketing_train) %>% dplyr::select(-ID)
marketing_train = marketing_train %>% dplyr::select(-ID)

```

**Построение дерева**  
Построим дерево, предсказывающее ответ на предложение. Так как в датасете представлено достаточно много критериев, то дерево, основанное на всех них получится слишком большим и сложным для анализа, а также возможен риск переобучения. Поэтому было решено не включать в построение дерева столбцы, показывающие сумму, потраченную на отдельные категории товаров, так как это достаточно детальная информация, влияние которой сложно предугадать, плюс к этому, у нас есть столбец с данными о доходе, а мы предполагаем, что траты и доход имеют взаимосвязь, поэтому так или иначе денежная составляющая будет учтена. Также для оптимизации дерева, не будем учитывать количество детей, так как уже имеется информация о семейном положении, а мы предполагаем, что взаимосвязь имеется. Помимо этого, не будем учитывать дату последей покупки, потому что существуют люди, которые совершабт покупки редко, но сразу большими объемами, а некоторые наоборот, поэтому мы не сможем это учесть.   
Итого мы строим дерево по следующим критериям: Year_Birth, Education, Marital_Status, Income, NumDealsPurchases, NumWebPurchases, NumStorePurchases, AcceptedCmp, Complain. 

```{r message = FALSE, warning=FALSE, fig.width=5}

set.seed(1234)
tree1 <- rpart(Response ~ Year_Birth + Education + Marital_Status + Income + NumDealsPurchases + NumWebPurchases + NumStorePurchases + AcceptedCmp + Complain, method = "class", data = marketing_train)
rpart.plot(tree1)

```
  
**Анализ**  
Мы получили достаточно хорошее дерево, в котором не слишклм много узлов, однако все таки присутствует ветвление. Также можем заметить, что не был использован год рождения, наличие жалоб.  
Проверим качество модели и сосчитаем accuracy

```{r message = FALSE, warning=FALSE}
pred = predict(tree1, type="class", data = marketing_train)
t = table(pred, marketing_train$Response)
t
(t[1,1] + t[2,2])/sum(t)

```
Мы видим, что получилось достаточно высокое значение Accuracy = 0.83, что говорит о достаточно высокой точности модели
Теперь посмотрим результат на тестовой выборке и посчитаем точность

```{r message = FALSE, warning=FALSE}
pred_test = predict(tree1, newdata = marketing_test, type="class")

t2 = table(pred_test, marketing_test$Response)
ac2 = (t2[1,1] + t2[2,2])/sum(t2)
```
Accuracy стала немного ниже (0.78), однако это все еще достаточно высокая точность. 

**Выводы**  
Как мы уже видели в исследовательском вопросе, на отвеет покупателя на предложение компании влияет его ответ на предыдущее предложение и количество покупок в интернете. Мы видим, что ответ на предыдущее предложение это первый критерий, по которому происходит разбиение. Далее происходит анализ числа покупок в интернете, за которым следует последующая классификация по семейному положению, доходу, уровню образования и количеству покупок в магазине. В целом, получилось довольно неплохое дерево с хорошим значением точности как на тренировочной, так и на тестовой выборках. Отсюда можно сделать вывод, что модель получилась хорошая, а значит она может быть применена для предсказания ответа потребителей компании на новые промоакции и для более детального анализа фокус групп, которым нужно предлагать акции. 
Теперь рассмотрим конкретнее группы, на которых стоит сфокусироваться согласно дереву:
- клиенты, откликнувшиеся на предыдущее предложение и совершившие более 2 покупок по скидке (крайняя правая ветка)
- клиенты, не откликнувшиеся на предыдущее предложение, совершившие не менее 3 интернет покупок, не состоящие в браке/отношениях:
  - и имеющие доход не менее 83000
  - с образованием уровня PHD и доходом менее 57000 или доходом более 68000
  - с образованием уровня не PHD и числом покупок в магазине (оффлайн) менее 3


## Общие выводы
Анализ датасета позволил изучить, какие показатели влияют на отношение клиента к предложениям компании. На основе полученной модели можно более точно сфокусироваться на вышеописанных группах клиентов, чтобы повысить эффективность маркетинговой кампании. 
Благодаря анализу и статистическим тестам стало понятно, что клиенты, которые чаще совершают покупки в интернете более склонны принимать предложение компании, как и клиенты, которые приняли предыдущее предложение. На основе этого анализа можно выдвинуть предположение о том, что это связано с большей лояльностью и доверием со стороны клиента. Интернет-магазин в меньшей степени может спровоцировать стресс, такой как длинные очереди и трата большого количества времени на поход в магазин, а значит, что клиент с большей вероятностью сформирует положительное впечатление о магазине. Клиенты, которые уже положительно откликались на промо-акции компании имеют опыт такого рода взаимодействия с компанией, а значит понимают, что это им интересно. Также было бы полезно анализировать, остались ли клиенты довольны предыдущим предложением компании, так как это позволило бы сузить круг наблюдения и понять, насколько эффективна была предыдущая акция и стоит ли рекламировать новое предложение тем клиентам, кто воспользовался предыдущим. 
Полученная модель дерева решений также показала, что на решение клиента влияет его доход и уровень образования, возможно, было бы полезно в будущем изучить влияние трат человека на товары по скидке и предыдущие акции компании. 
В целом, анализ позволил построить достаточно точную модель, которая предсказывает ответ клиента, в зависимости от определенных критериев, однако всегда есть перспектива для улучшения модели, которое может быть получении благодаря уточнению данных и дополнительному опросу клиентов, хотя уже сейчас можно понимать, на какую аудиторию стоит таргетировать рекламу, чтобы получить наибольший отклик. 




























